<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIDI Sequential Interactive Visualizer</title>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.16"></script>
    <script src="https://unpkg.com/@tonejs/midi"></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
        }

        #controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 100;
            background: rgba(255, 255, 255, 0.15);
            padding: 10px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        #track-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #track {
            position: absolute;
            left: 100px;
            top: 0;
            height: 100%;
            transition: transform 0.2s ease-out;
        }

        .chord-group {
            position: absolute;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 10px 15px;
            border: 1.5px solid #00f2ff;
            background: rgba(0, 242, 255, 0.1);
            border-radius: 6px;
            white-space: nowrap;
            box-shadow: 0 0 8px rgba(0, 242, 255, 0.2);
            transition: opacity 0.3s, transform 0.3s;
        }

        /* 화음 위 숫자 표시 스타일 */
        .count-badge {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #ff00ff;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 0 10px #ff00ff;
        }

        .chord-group.active {
            border-color: #ff00ff;
            box-shadow: 0 0 15px #ff00ff;
            background: rgba(255, 0, 255, 0.2);
            transform: scale(1.1);
        }

        .note-char {
            font-weight: bold;
            color: #fff;
            text-shadow: 1px 1px 2px #000;
        }
    </style>
</head>

<body>
    <div id="controls">
        <input type="file" id="midi-upload" accept=".mid,.midi">
        <span id="status">파일을 업로드하세요.</span>
    </div>
    <div id="track-container">
        <div id="track"></div>
    </div>

    <script>
        const NOTE_HEIGHT = 100;
        const MIN_GAP = 50;
        const PIXELS_PER_SECOND = 120;

        const midiMap = {
            "C1": "1", "C#1": "!", "D1": "2", "D#1": "@", "E1": "3", "F1": "4", "F#1": "$", "G1": "5", "G#1": "%", "A1": "6", "A#1": "^", "B1": "7",
            "C2": "8", "C#2": "*", "D2": "9", "D#2": "(", "E2": "0", "F2": "q", "F#2": "Q", "G2": "w", "G#2": "W", "A2": "e", "A#2": "E", "B2": "r",
            "C3": "t", "C#3": "T", "D3": "y", "D#3": "Y", "E3": "u", "F3": "i", "F#3": "I", "G3": "o", "G#3": "O", "A3": "p", "A#3": "P", "B3": "a",
            "C4": "s", "C#4": "S", "D4": "d", "D#4": "D", "E4": "f", "F4": "g", "F#4": "G", "G4": "h", "G#4": "H", "A4": "j", "A#4": "J", "B4": "k",
            "C5": "l", "C#5": "L", "D5": "z", "D#5": "Z", "E5": "x", "F5": "c", "F#5": "C", "G5": "v", "G#5": "V", "A5": "b", "A#5": "B", "B5": "n",
            "C6": "m", "C#6": "M"
        };

        const lines = ["1!2@34$5%6^78*90", "qQwWeErRtTyYuUiIoOpP", "asSdDfGgHhJjklL", "zZxCcVvBbNmM"];
        const keyLineMap = {};
        lines.forEach((chars, index) => {
            for (const char of chars) keyLineMap[char] = index + 1;
        });

        let playbackData = [];
        let currentIndex = 0;
        let noteInChordIndex = 0;

        const emotional = new Tone.Sampler({
            urls: { "C4": "C4.mp3" }, // 실제 샘플 경로에 맞춰 수정 필요
            volume: -12,
            baseUrl: "./sound/Emotional/",
            release: 1.5,
        }).toDestination();

        document.getElementById('midi-upload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('status').innerText = "로딩 중...";
            const arrayBuffer = await file.arrayBuffer();
            const midi = new Midi(arrayBuffer);
            renderMidi(midi);
            document.getElementById('status').innerText = "준비 완료! 키보드를 누르세요.";
            await Tone.start();
        });

        function renderMidi(midi) {
            const track = document.getElementById('track');
            track.innerHTML = "";
            currentIndex = 0;
            noteInChordIndex = 0;
            playbackData = [];

            let allNotes = [];
            midi.tracks.forEach(t => {
                t.notes.forEach(note => {
                    const char = midiMap[note.name];
                    if (char) allNotes.push({ time: note.time, char, midi: note.midi, name: note.name });
                });
            });

            const groups = {};
            allNotes.forEach(note => {
                const timeKey = Math.round(note.time * 1000) / 1000;
                if (!groups[timeKey]) groups[timeKey] = [];
                groups[timeKey].push(note);
            });

            const sortedTimes = Object.keys(groups).sort((a, b) => a - b);
            let currentX = 0;
            let lastTime = 0;

            sortedTimes.forEach((timeKey, index) => {
                const chordNotes = groups[timeKey].sort((a, b) => a.midi - b.midi);
                const groupDiv = document.createElement('div');
                groupDiv.className = 'chord-group';
                if (index === 0) groupDiv.classList.add('active');

                // 숫자 배지 추가
                const countBadge = document.createElement('div');
                countBadge.className = 'count-badge';
                countBadge.innerText = chordNotes.length; // 초기 숫자: 화음 내 음 개수
                groupDiv.appendChild(countBadge);

                chordNotes.forEach(note => {
                    const span = document.createElement('span');
                    span.className = 'note-char';
                    span.innerText = note.char;
                    span.style.fontSize = `18px`;
                    span.style.margin = "0 4px";
                    groupDiv.appendChild(span);
                });

                track.appendChild(groupDiv);
                const groupWidth = groupDiv.offsetWidth;
                const timeDiff = parseFloat(timeKey) - lastTime;
                const spacing = Math.max(MIN_GAP, timeDiff * PIXELS_PER_SECOND);
                const posX = currentX + spacing;
                const posY = (keyLineMap[chordNotes[0].char] || 1) * NOTE_HEIGHT;

                groupDiv.style.left = `${posX}px`;
                groupDiv.style.top = `${posY}px`;

                playbackData.push({
                    element: groupDiv,
                    badge: countBadge,
                    chars: chordNotes.map(n => n.char),
                    notes: chordNotes.map(n => n.name),
                    x: posX
                });

                currentX += spacing + groupWidth;
                lastTime = parseFloat(timeKey);
            });
        }

        function playNote(noteName) {
            emotional.triggerAttackRelease(noteName, "8n");
        }

        window.addEventListener('keydown', (e) => {
            if (e.repeat || currentIndex >= playbackData.length) return;
            if (e.key.length > 1 && !["Enter", " ", "Backspace"].includes(e.key)) return;

            const currentChord = playbackData[currentIndex];

            // 음 연주
            const noteName = currentChord.notes[noteInChordIndex];
            playNote(noteName);

            // 시각적 피드백 (글자 색 연하게)
            const charSpans = currentChord.element.querySelectorAll('.note-char');
            if (charSpans[noteInChordIndex]) {
                charSpans[noteInChordIndex].style.color = "#555";
            }

            noteInChordIndex++;

            // 남은 숫자 업데이트
            const remaining = currentChord.chars.length - noteInChordIndex;
            currentChord.badge.innerText = remaining > 0 ? remaining : "✓";

            // 화음 완료 체크
            if (noteInChordIndex >= currentChord.chars.length) {
                const targetElement = currentChord.element;
                targetElement.style.opacity = "0";
                targetElement.style.transform = "translateY(-30px) scale(0.8)";

                noteInChordIndex = 0;
                currentIndex++;

                if (currentIndex < playbackData.length) {
                    const nextChord = playbackData[currentIndex];
                    nextChord.element.classList.add('active');
                    const track = document.getElementById('track');
                    track.style.transform = `translateX(${-nextChord.x + 100}px)`;
                } else {
                    document.getElementById('status').innerText = "연주 완료!";
                }
            }
        });
    </script>
</body>

</html>